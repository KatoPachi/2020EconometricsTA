---
title: "Econometrics II TA Session #5"
author: "Hiroki Kato"
output:
  pdf_document:
    latex_engine: xelatex
    md_extensions: +raw_attribute
    number_sections: true
    extra_dependencies: ["xcolor"]
    keep_tex: yes
fontsize: 12pt
header-includes:
  - \usepackage{zxjatype}
  - \setCJKmainfont[BoldFont = IPAゴシック]{IPA明朝}
  - \setCJKsansfont{IPAゴシック}
  - \setCJKmonofont{IPAゴシック}
  - \parindent = 1em
  - \newcommand{\argmax}{\mathop{\rm arg~max}\limits}
  - \newcommand{\argmin}{\mathop{\rm arg~min}\limits}
  - \DeclareMathOperator*{\plim}{plim}
---

```{r setup, include = FALSE, echo = FALSE, purl = FALSE}
# This is options to make pdf file. You should ignore
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  echo = TRUE, 
  cache = FALSE,
  fig.pos = "h")
knitr::opts_knit$set(root.dir = "C:/Users/katoo/Desktop/2020EconometricsTA/R")
```

# Empirical Application of Truncated Regression: Labor Participation of Married Women

## Background and Data

To develop women's social advancement,
we should create environment to keep a good balance between work and childcare after marriage.
In this application, using the dataset of married women, 
we explore how much childcare prevents married women to participate in labor market.

Our dataset originally comes from Stata sample data. [^source3]
This dataset contains the following variables:

- `whrs`: Hours of work. This outcome variable is truncated from below at zero.
- `kl6`: the number of preschool children
- `k618`: The number of school‐aged children
- `wa`: age
- `we`: The number of years of education

[^source3]: <http://www.stata-press.com/data/r13/laborsub.dt>. Because this is dta file, we need to import it, using the `read.dta` function in the library `foreign`. I intentionally remove married women who could not participate in the labor market.

```{r laborData}
dt <- read.csv(file = "./data/labor.csv", header = TRUE,  sep = ",")
summary(dt)
```

## Model 

Since we cannot observe those who could not partiapte in the labor market (`whrs = 0`),
we use the truncated regression model.
Thus, the selection rule is as follows:

\begin{equation*}
  \begin{cases}
    y_i = x_i \beta + u_i &\text{if}\:\: s_i = 1  \\
    s_i = 1 &\text{if}\:\: a_1 < y_i < a_2
  \end{cases}.
\end{equation*}
where $u_i \sim N(0, \sigma^2)$.
In this case, $a_1 = 0$ and $a_2 = +\infty$.

Since we are interested in estimating $\beta$, we must condition on $s_i = 1$.
The probability density function of $y_i$ conditional on $(x_i, s_i = 1)$ is 

\begin{equation*}
  p_{\theta}(y_i | x_i, s_i = 1) = \frac{f(y_i | x_i)}{\int_0^{+\infty} f(y_i | x_i) dy_i}.
\end{equation*}
where $\theta = (\beta, \sigma^2)'$.
Because the distribution of $y_i$ depends on the distribution of $u_i$,
using $u_i = y_i - x_i \beta$, we obtain 

\begin{equation*}
  p_{\theta}(u_i | x_i, -x_i \beta < u_i) 
  = \frac{1}{\sigma} \frac{\phi(\frac{y_i - x_i \beta}{\sigma})}{1 - \Phi(\frac{- x_i \beta}{\sigma})}.
\end{equation*}
Thus, the log-likelihood function is 

\begin{equation*}
  M_n(\theta) 
  = \sum_{i=1}^n \log \left( \frac{1}{\sigma} \frac{\phi(\frac{y_i - x_i \beta}{\sigma})}{1 - \Phi(\frac{- x_i \beta}{\sigma})} \right).
\end{equation*}

We provide two ways to estimate truncated regression, using `R`.
First way is to define the log-likelihood function directly and minimize its function by `nlm` function.
Recall that `nlm` function provides the Newton method to minimize the function.
We need to give intial values in argument of this function.
Coefficients of explanatory variables, `b[3:6]`, are zero, 
and intercept, `b[2]`, and $\sigma$, `b[1]`, are given by mean and standard deviation of `whrs`, respectively.

```{r truncMle}
whrs <- dt$whrs
kl6 <- dt$kl6; k618 <- dt$k618
wa <- dt$wa; we <- dt$we

LnLik <- function(b) {
  sigma <- b[1]
  xb <- b[2] + b[3]*kl6 + b[4]*k618 + b[5]*wa + b[6]*we
  condp <- dnorm((whrs - xb)/sigma)/(1 - pnorm(-xb/sigma))
  LL_i <- log(condp/sigma)
  LL <- -sum(LL_i)
  return(LL)
}

init <- c(sd(whrs), mean(whrs), 0, 0, 0, 0)
est.LnLik <- nlm(LnLik, init, hessian = TRUE)
```

Second way is to use the function `truncreg` in the library `truncreg`.
This function must specify the trucated point in arguments `point` and `direction`.
If `direction = "left"`, the outcome variable is truncated from below at `point`, that is, `point < y`.
On the other hand, if `direction = "right"`, the outcome variable is truncated from above at `point`, that is, `y < point`.

```{r truncreg}
library(truncreg)
model <- whrs ~ kl6 + k618 + wa + we
est.trunc <- truncreg(model, data = dt, point = 0, direction = "left")
se.trunc <- sqrt(diag(vcov(est.trunc)))
```


## Interpretations

Table \ref{lfp} shows results of truncated regression estimated by two methods.
As a comparison, we also show the OLS result in column (3).
All specifications show that the number of preschool and school-aged children reduces the hours of work.
The size of coefficient of the number of preschool and school-aged children become stronger
when we apply the truncated regression.
Although the relationship between labor participation and women's characteristics is statistically insignificant,
size of coefficients largely differs among three specifications.

```{r tab_truncate, results = "asis"}
ols <- lm(model, data = dt)
coef.LnLik <- est.LnLik$estimate
se.LnLik <- sqrt(diag(solve(est.LnLik$hessian)))
names(coef.LnLik) <- c("sigma", names(coef(ols)))
names(se.LnLik) <- c("sigma", names(coef(ols)))

library(stargazer)
stargazer(
  ols, ols, ols,
  column.labels = c("Truncated (truncreg)", "Truncated (nlm)", "OLS"),
  coef = list(coef(est.trunc), coef.LnLik[2:6]),
  se = list(se.trunc, se.LnLik[2:6]),
  report = "vcs", keep.stat = c("n"),
  covariate.labels = c(
    "\\#.Preschool Children",
    "\\#.School-aged Children",
    "Age", "Education Years"
  ),
  add.lines = list(
    c("Estimated Sigma", 
      round(coef(est.trunc)[6], 3), round(coef.LnLik[1], 3)),
    c("Log-Likelihood", 
      round(est.trunc$logLik, 3), round(-est.LnLik$minimum, 3))
  ),
  omit.table.layout = "n", table.placement = "t",
  title = "Truncated Regression: Labor Market Participation of Married Women",
  label = "lfp",
  type = "latex", header = FALSE  
)
```

